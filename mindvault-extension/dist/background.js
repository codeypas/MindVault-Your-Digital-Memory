const s=globalThis.chrome;let t=null;async function d(n,e){if(!n||e<=0)return;const l=(await s.storage.local.get(["websites"])).websites||[],o=l.findIndex(c=>c.url===n);if(o!==-1){const c=l[o];c.totalTimeSpent=(c.totalTimeSpent||0)+e}else l.unshift({id:Date.now().toString(),url:n,title:"Unknown Title",timestamp:new Date().toISOString(),favicon:null,totalTimeSpent:e});const r=l.slice(0,1e3);await s.storage.local.set({websites:r})}s.tabs.onActivated.addListener(async n=>{const e=await s.windows.get(n.windowId);if(e.focused){if(t&&t.url&&t.windowId===e.id){const l=Date.now()-t.startTime;await d(t.url,l)}const i=await s.tabs.get(n.tabId);i.url&&!i.url.startsWith("chrome://")?t={tabId:n.tabId,url:i.url,startTime:Date.now(),windowId:n.windowId}:t=null}else if(t&&t.windowId===e.id){const i=Date.now()-t.startTime;await d(t.url,i),t=null}});s.tabs.onRemoved.addListener(async(n,e)=>{if(t&&t.tabId===n){const i=Date.now()-t.startTime;await d(t.url,i),t=null}});s.windows.onFocusChanged.addListener(async n=>{if(n===s.windows.WINDOW_ID_NONE){if(t){const e=Date.now()-t.startTime;await d(t.url,e),t=null}}else{const e=await s.tabs.query({active:!0,windowId:n});e.length>0&&e[0].url&&!e[0].url.startsWith("chrome://")?t={tabId:e[0].id,url:e[0].url,startTime:Date.now(),windowId:n}:t=null}});s.tabs.onUpdated.addListener((n,e,i)=>{e.status==="complete"&&i.url&&!i.url.startsWith("chrome://")&&s.storage.local.get(["websites"],l=>{const o=l.websites||[],r=o.findIndex(a=>a.url===i.url);if(r!==-1){const a=o[r];a.timestamp=new Date().toISOString(),a.title=i.title||"Unknown Title",a.favicon=i.favIconUrl||null,o.splice(r,1),o.unshift(a)}else{const a={id:Date.now().toString(),url:i.url,title:i.title||"Unknown Title",timestamp:new Date().toISOString(),favicon:i.favIconUrl||null,totalTimeSpent:0};o.unshift(a)}const c=o.slice(0,1e3);s.storage.local.set({websites:c})})});s.runtime.onMessage.addListener((n,e,i)=>{var l,o;if(n.type==="CLIPBOARD_CAPTURED"){const r={id:Date.now().toString(),content:n.content,timestamp:new Date().toISOString(),sourceUrl:((l=e.tab)==null?void 0:l.url)||null,sourceTitle:((o=e.tab)==null?void 0:o.title)||null};s.storage.local.get(["clipboard"],c=>{const a=c.clipboard||[];if(a.length>0&&a[0].content===r.content){i({success:!1,message:"Duplicate content ignored"});return}a.unshift(r);const u=a.slice(0,1e3);s.storage.local.set({clipboard:u})}),i({success:!0})}});
